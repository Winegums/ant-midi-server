<!doctype html>
<html>

<head>
  <title>🎛️🐜 - Aunt Colony </title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <!--

                                                      ██▓▓██
                                                    ██▓▓██        ██████████
                                                  ██▓▓██      ████▓▓▓▓▓▓▓▓▓▓██
                                                ██▓▓██      ██▓▓▒▒▒▒▒▒▓▓▓▓▓▓██
                                                ██▓▓██    ██▓▓▒▒▒▒▒▒▒▒▓▓▓▓▓▓██
                                                ██▓▓██  ██▓▓▒▒▒▒▒▒▒▒▓▓▓▓▓▓██
                                              ██▓▓██  ██▓▓▒▒▒▒▒▒▒▒▓▓▓▓▓▓▓▓██
                                              ██▓▓██  ██▒▒▒▒▒▒▒▒▓▓▓▓▓▓▓▓██
                          ██████              ██▓▓██  ██▒▒▒▒▒▒▓▓▓▓▓▓▓▓██
                  ████████▒▒▒▒▒▒████          ██▓▓████▓▓▒▒▒▒▓▓▓▓▓▓▓▓██
            ██████▓▓▓▓▓▓▓▓██████▒▒▒▒██        ██▓▓████▓▓▓▓▓▓▓▓▓▓▓▓██
            ██▓▓▓▓████████      ████▓▓██        ██████▓▓▓▓▓▓▓▓████  ██████
              ████                  ██▓▓██  ████▓▓▓▓▓▓██▓▓████  ████▒▒▒▒▓▓██████
                                      ██▓▓██▓▓▓▓▒▒▒▒▓▓▓▓██  ████▓▓▒▒██████▓▓▓▓▓▓
                      ██████            ██▓▓▒▒▒▒▒▒▓▓▓▓██████▓▓▓▓████      ██████
                  ████▒▒▒▒▒▒████      ██▓▓▒▒▒▒▒▒▓▓▓▓██▓▓▓▓▓▓████
                ██▒▒▒▒██████▒▒▒▒████  ██▒▒▒▒▒▒▓▓▓▓████████████████
              ██▒▒████      ████▓▓▓▓██▓▓▒▒▒▒▓▓████▓▓▓▓▓▓▒▒▒▒▒▒▒▒▓▓██
            ██▓▓██              ██████▓▓▒▒▓▓██▒▒██████████████████▓▓██
          ██▓▓██                    ██▓▓▓▓▓▓██▒▒██                ██▓▓██
        ██▓▓██                ████████▓▓▓▓████▒▒██                ██▓▓██
      ██▓▓██              ████▓▓▓▓▓▓▓▓████  ██▒▒██                ██▓▓██
    ██▓▓██              ██▓▓▒▒▒▒▒▒▓▓▓▓██    ██▒▒██                ██▓▓██
  ██▓▓██              ██▓▓▒▒██▒▒▒▒▓▓▓▓██    ██▓▓██                  ██▓▓██
  ████          ████████████▒▒▒▒██▓▓▓▓██    ██▓▓██                    ██▓▓████
            ████    ██▓▓▒▒▒▒▒▒██▓▓▓▓▓▓██    ██▓▓██                      ██▓▓▓▓██
          ██      ██▓▓▒▒▒▒▒▒▓▓██▓▓████      ██▓▓██                        ██████
        ██        ██▓▓▒▒▒▒▓▓▓▓▓▓██▓▓██      ██▓▓██
        ██        ██▓▓▓▓▓▓▓▓▓▓██▓▓██        ██▓▓██
      ██        ██▓▓████▓▓▓▓▓▓████  ██      ██▓▓██
    ██          ██▓▓██  ██████      ██    ██▓▓██
████            ████  ██▓▓▓▓██      ██    ██▓▓██       auntcolony.com
                    ██▓▓████      ██      ██▓▓██
                    ████          ██      ██▓▓██
                    ░░░░        ▓▓░░      ██▓▓██
                              ██░░        ██▓▓██
                            ██            ██▓▓██
                          ██              ██▓▓██
                          ██              ████
                        ██
                        ██
                        ██
                        ██
                        ██

-->
  <link rel="stylesheet" type="text/css" href="public/css/main.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css">
</head>

<body>
  <div id="app">
    <section class="section">
      <div class="container">
        <div class="columns">
          <div class="column">
            <h1 class="title">🎛️ 🐜</h1>
            <div class="field">
              <div class="control">
                <div class="select">
                  <select v-on:change='onOutputChange' v-model='midiOutIndex'>
                    <option value="-1">Select Output</option>
                    <option v-for='name, i in outputList' v-bind:value='i'>{{ name }}</option>
                    <option value='synth'>Web Synth</option>
                  </select>
                </div>
              </div>
            </div>
            <table class="table">
              <thead>
                <tr>
                  <th>Channel</th>
                  <th>Command</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody name="list" is="transition-group">
                <template v-for='message in messages'>
                  <tr v-bind:key="message.id" class="list-item">
                    <td>{{ getChannel(message) }}</td>
                    <td>{{ getCommand(message) }}</td>
                    <td>{{ getNote(message) }}</td>
                  </tr>
                </template>
              </tbody>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tone@14.7.58/build/Tone.min.js"></script>
  <script>
    var socket = io('https://auntcolony.com');

    var app = new Vue({
      el: '#app',
      data: {
        synth: null,
        messages: [],
        midiOutIndex: -1,
        midiAccess: null,
        noteMap: ["E2", "F2", "F#2", "G2", "G#2", "A2", "A#2", "B2", "C3", "C#3", "D3", "D#3", "E3", "F3", "F#3", "G3", "G#3", "A3", "A#3", "B3", "C4", "C#4", "D4", "D#4", "E4", "F4", "F#4", "G4", "G#4", "A4", "A#4", "B4", "C5", "C#5", "D5", "D#5", "E5", "F5", "F#5", "G5", "G#5", "A5", "A#5", "B5", "C6", "C#6", "D6", "D#6", "E6", "F6", "F#6", "G6", "G#6", "A6", "A#6", "B6", "C7", "C#7", "D7", "D#7", "E7", "F7", "F#7", "G7", "G#7", "A7", "A#7", "B7", "C8", "C#8", "D8", "D#8", "E8", "F8", "F#8", "G8", "G#8", "A8", "A#8", "B8", "C9", "C#9", "D9", "D#9", "E9", "F9", "F#9", "G9", "G#9"]
      },
      computed: {
        inputList() {
          let inputs = [];
          if (this.midiAccess) {
            this.midiAccess.inputs.forEach(input => {
              inputs.push(input.name)
            });
          }
          return inputs;
        },
        outputList() {
          let outputs = [];
          if (this.midiAccess) {
            this.midiAccess.outputs.forEach(output => {
              outputs.push(output.name)
            });
          }
          return outputs;
        },
        midiOutput() {
          if (this.midiAccess) {
            return Array.from(this.midiAccess.outputs.values())[this.midiOutIndex];
          } else {
            return null;
          }
        }
      },
      methods: {
        initMidi() {
          if (navigator.requestMIDIAccess) {
            navigator.requestMIDIAccess()
              .then(this.onMIDISuccess, this.onMIDIFailure);
          } else {
            console.log('WebMIDI is not supported in this browser.');
          }
        },
        handleMIDIMessage(data) {
          if (this.synth) {
            this.synthHandleMIDIMessage(data);
          } else {
            if (this.midiOutput) {
              const midiMessage = [data.x, data.y, data.z];
              this.midiOutput.send(midiMessage);
            }
          }
        },
        initSocketHandler() {
          socket.on('osc', (data) => {
            data.id = this.uuidv4();
            this.handleMIDIMessage(data);
            this.messages = [data, ...this.messages.slice(0, 4)];
          });
        },
        onMIDISuccess(midiAccess) {
          this.midiAccess = midiAccess;
          midiAccess.onstatechange = function (e) {
            // Print information about the (dis)connected MIDI controller
            console.log(e.port.name, e.port.manufacturer, e.port.state);
          };
        },
        onMIDIFailure() {
          console.log('Could not access your MIDI devices.');
        },
        onOutputChange(e) {
          if (e.target.value === 'synth') {
            this.initSynth();
          } else {
            this.synth = null;
          }
        },
        getChannel(data) {
          var noteChannel;
          if (data.x < 144 && data.x >= 128) {
            noteChannel = (data.x - 128) + 1;
          } else if (data.x >= 144) {
            noteChannel = (data.x - 144) + 1;
          }
          return noteChannel;
        },
        getCommand(data) {
          var command;
          if (data.x < 144 && data.x >= 128) {
            command = "Note Off";
          } else if (data.x >= 144) {
            command = "Note On";
          }
          return command
        },
        getNote(data) {
          return this.noteMap[data.y - 40];
        },
        midiToString(data) {
          var note = this.noteMap[data.y - 40];
          var noteType, noteChannel;
          if (data.x < 144 && data.x >= 128) {
            noteType = "OFF";
            noteChannel = (data.x - 128) + 1;
          } else if (data.x >= 144) {
            noteType = "ON";
            noteChannel = (data.x - 144) + 1;
          }
          return `Channel: ${noteChannel} Command: ${noteType}  Note: ${note}`;
        },
        uuidv4() {
          // https://stackoverflow.com/a/2117523
          return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
            (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
          );
        },
        async initSynth() {
          await Tone.start()
          this.synth = new Tone.MonoSynth({
            oscillator: {
              type: "square"
            },
            envelope: {
              attack: 0.1,
              decay: 0.2,
              sustain: 0.5,
              release: 0.8,
            }
          }).toDestination();
        },
        synthHandleMIDIMessage(data) {
          const note = this.getNote(data)

          if (data.x < 144 && data.x >= 128) {
            console.log('note off')
            this.synth.triggerRelease();
          } else if (data.x >= 144) {
            console.log('playing ' + note);
            this.synth.triggerAttack(note);
          }
        },
      },
      created() {
        this.initMidi();
        this.initSocketHandler();
      }
    })
  </script>


</body>

</html>
